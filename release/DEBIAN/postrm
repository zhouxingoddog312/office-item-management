#!/bin/bash
#遇到错误立即终止，避免无效操作
set -e
#参数配置
MAKEFILE_PATH="../../Makefile"
ICON_SIZES="$(echo $(grep 'ICON_SIZES:=' "$MAKEFILE_PATH" | cut -d'=' -f2 | sed 's/^[ \t]*//'))"
ICON_TARGET_NAME="$(grep 'ICON_TARGET_NAME:=' "$MAKEFILE_PATH" | cut -d'=' -f2 | sed 's/^[ \t]*//')"
LIB_FILE_NAME="$(basename $(grep 'LIB_FILE_SRC:=' "$MAKEFILE_PATH" | cut -d'=' -f2 | sed 's/^[ \t]*//'))"
DESKTOP_TARGET_NAME="$(basename $(grep 'DESKTOP_SRC:=' "$MAKEFILE_PATH" | cut -d'=' -f2 | sed 's/^[ \t]*//'))"
SYSTEM_ICON_ROOT="/usr/share/icons/hicolor"
SYSTEM_DESKTOP_DIR="/usr/share/applications"
SYSTEM_BIN_DIR="/usr/local/bin"

#校检权限
if [ "$(id -u)" -ne 0 ]
then
	echo "错误：清理系统级资源需root权限，当前用户无权限" >&2
	exit 1
fi
#清理残留文件
function clean_residual_files()
{
	echo "===清理残留文件==="
#清理可能残留的库文件functions
	local lib_file_path="$SYSTEM_BIN_DIR/$LIB_FILE_NAME"
	if [ -f "$lib_file_path" ]
	then
		rm -fv "$lib_file_path"
		echo "已删除残留库文件：$lib_file_path"
	fi
#清理可能残留的桌面文件
	local desktop_path="$SYSTEM_DESKTOP_DIR/$DESKTOP_TARGET_NAME"
	if [ -f "$desktop_path" ]
	then
		rm -fv "$desktop_path"
		echo "已删除残留桌面文件：$desktop_path"
	fi
#清理可能残留的图标文件
	for size in $ICON_SIZES
	do
		local icon_path="$SYSTEM_ICON_ROOT/$size/apps/$ICON_TARGET_NAME"
		if [ -f "$icon_path" ]
		then
			rm -fv "$icon_path"
			echo "已删除残留图标文件：$icon_path"
		fi
	done
}
#清理空目录
function clean_empty_dirs()
{
	echo -e "\n=== 清理空目录 ==="
#清理图标尺寸目录
	for size in $ICON_SIZES
	do
		local icon_dir="$SYSTEM_ICON_ROOT/$size/apps"
		if [ -d "$icon_dir" ] && [ -z "$(ls -A "$icon_dir")" ]
		then
			rmdir -v "$icon_dir"
		fi
	done
}
#刷新缓存
function refresh_caches()
{
	echo -e "\n===刷新缓存移除残留记录==="
	if command -v update-icon-caches &>/dev/null
	then
		echo "刷新图标缓存：$SYSTEM_ICON_ROOT"
		update-icon-caches -f "$SYSTEM_ICON_ROOT"
	else
		echo "警告：未找到update-icon-caches，需手动刷新图标缓存" >&2
	fi
	if command -v update-desktop-database &>/dev/null
	then
		echo "刷新桌面数据库：$SYSTEM_DESKTOP_DIR"
		update-desktop-database -q "$SYSTEM_DESKTOP_DIR"
	else
		echo "警告：未找到update-desktop-database，需手动刷新桌面数据库" >&2
	fi
}
#主执行逻辑
#校验Makefile是否存在
if [ ! -f "$MAKEFILE_PATH" ]
then
	echo "错误：未找到根目录的Makefile（路径：$MAKEFILE_PATH），请检查目录结构" >&2
	exit 1
fi
clean_residual_files
clean_empty_dirs
refresh_caches
echo -e "\n=== 应用卸载完成 ==="
echo "所有残留文件和空目录已清理"
exit 0
