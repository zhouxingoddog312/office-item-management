#!/bin/bash
#遇到错误立即终止，避免无效操作
set -e
#获取实际用户信息，排除sudo的影响，（同时考虑命令行和图形安装）
function get_real_user()
{
#若通过sudo安装，获取实际用户（用于命令行）
	if [ -n "$SUDO_USER" ]
	then
		echo "$SUDO_USER"
		return
	fi
#图形安装时通过logname获取实际用户
	if command -v logname &>/dev/null
	then
		local login_user=$(logname 2>/dev/null)
		if [ -n "$login_user" ]
		then
			echo "$login_user"
			return
		fi
	fi
	echo "$USER"
}
#处理图标文件的函数
function handle_icons()
{
#实际用户
	local real_user="$1"
#实际用户的家目录
	local real_home="$2"
#图标源目录
	local icon_source_dir="$3"
#图标目标根目录
	local icon_target_root="$4"
#目标图标统一命名
	local icon_target_name="$5"
#剩余参数为图标尺寸列表
	shift 5
	local icon_sizes=("$@")
	echo "===开始处理图标文件（强制覆盖现有图标）==="
#检查图标源目录是否存在
	if [ ! -d "$icon_source_dir" ]
	then
		echo "错误：图标源目录$icon_source_dir不存在，跳过图标安装" >&2
		return 1
	fi
#遍历图标尺寸，处理对应图标，源图标命名需含有如16x16样式子字符串
}



if [ -n "$SUDO_USER" ]
then
#若通过sudo安装，获取原始用户的家目录
	USER_HOME=$(eval echo ~"$SUDO_USER")
else
#若直接以root安装（极少情况），使用当前HOME（不推荐）
	USER_HOME="$HOME"
fi
#图标源目录
ICON_SOURCE_DIR="/usr/share/office-item-management/icons"
#图标目标根目录
ICON_TARGET_ROOT="$USER_HOME/.local/share/icons/hicolor"
#图标目标统一命名
ICON_TARGET_NAME="office-item-management.png"
#所有图标的尺寸
ICON_SIZE=("16x16" "32x32" "48x48" "64x64" "128x128" "256x256" "512x512")

#desktop文件
DESKTOP_SOURCE="/usr/share/office-item-management/oim.desktop"
DESKTOP_TARGET_DIR="$USER_HOME/.local/share/applications"
DESKTOP_TARGET="$DESKTOP_TARGET_DIR/oim.desktop"

#处理图标文件
for size in "${ICON_SIZE[@]}"
do
	source_icon="$ICON_SOURCE_DIR/$size.png"
	target_dir="$ICON_TARGET_ROOT/$size/apps"
	target_icon="$target_dir/$ICON_TARGET_NAME"
	if [ ! -f "$source_icon" ]
	then
		echo "警告：源图标$source_icon不存在，跳过安装"
		continue
	fi
#确保放入图标的父目录存在
	mkdir -p "$target_dir"
	mv "$source_icon" "$target_icon"
	chmod 644 "$target_icon"
	if [ -n "$SUDO_USER" ]
	then
		chown "$SUDO_USER":"$SUDO_USER" "$target_icon"
	fi
	echo "图标文件已安装：$target_icon"
done
update-icon-caches "$ICON_TARGET_ROOT"

#处理desktop文件
#确保用户级applications存在
mkdir -p "$DESKTOP_TARGET_DIR"
#移动desktop文件到用户级applications目录中
if [ -f "$DESKTOP_SOURCE" ]
then
	mv "$DESKTOP_SOURCE" "$DESKTOP_TARGET"
#赋予可执行权限
	chmod +x "$DESKTOP_TARGET"
#修正desktop文件所有者为实际用户而非root
	if [ -n "$SUDO_USER" ]
	then
		chown "$SUDO_USER":"$SUDO_USER" "$DESKTOP_TARGET"
	fi
#更新桌面数据库，让系统识别desktop文件
	update-desktop-database "$DESKTOP_TARGET_DIR"
	echo "桌面快捷方式已安装到$DESKTOP_TARGET_DIR"
else
	echo "错误：源文件$DESKTOP_SOURCE不存在，无法移动！"
	exit 1
fi
echo "oim functions已安装到/usr/local/bin/"
echo "office-item-management has been installed successfully!"
